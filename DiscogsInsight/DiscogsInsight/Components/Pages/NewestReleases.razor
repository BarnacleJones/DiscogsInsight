@page "/newest"
@using DiscogsInsight.View.Services.Collection
@using DiscogsInsight.View.Services.Releases
@using DiscogsInsight.ViewModels.EntityViewModels
@using DiscogsInsight.DataAccess.Services
@using DiscogsInsight.View.Services.Notifications
@using DiscogsInsight.ViewModels.Results
@inject UserNotificationService UserNotificationService
@inject ReleaseViewService ReleaseViewService
@inject CollectionViewService CollectionViewService
@inject NavigationManager NavigationManager

        
    @if (_hasKey)
    {
        <RadzenText Text="Newest 5 Releases" TextStyle="TextStyle.DisplayH4" />
        <br />           

        <div class="rz-p-sm-12">            
            @if (_latestReleases != null)
            {
                foreach (var item in _latestReleases)
                {
                    <ReleaseComponent Release="@item" />
                }
            }
        </div>
    }
    else
    {
        <label for="userNameInput">Enter Discogs Username: </label>
        <input type="text" @bind="discogsUsername">
        <br />
        <button class="btn btn-primary"   @onclick="handleButtonClick">Store Username</button>
        <hr />
        <p>This app will fetch your Discogs collection (currently up to 1000 items) using your username</p>
        <p>The data will be stored locally and used for gaining statistical insights into your collection.</p>
    }


@code{
    private static bool _hasKey { get; set; }
    private string discogsUsername = string.Empty;
    private List<ReleaseViewModel>? _latestReleases;

    public void handleButtonClick()
    {
        Preferences.Default.Set("discogsUsername", discogsUsername);
        _hasKey = true;
    }

    protected override async Task OnInitializedAsync()
    {
        _hasKey = Preferences.Default.ContainsKey("discogsUsername");
        if (_hasKey)
        {
            var ensureCollectionIsSeeded = await CollectionViewService.GetCollection();
            HandleNewestReleaseResult(await ReleaseViewService.GetNewestReleases());
        }
    }
    
    private async void HandleNewestReleaseResult(ViewResult<List<ReleaseViewModel>> result)
    {
        if (result.Success)
        {
            _latestReleases = result.Data;
        }
        else
        {
            await UserNotificationService.DisplayNotification("Error", $"{result.ErrorMessage}", "OK", "Cancel");
        }
    }
}